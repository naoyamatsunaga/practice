## MVVM ファイル構成ガイド（“MVV”はMVVMの意と解釈）

本プロジェクトでは、画面(UI)と状態(ViewModel)とデータ(Model/Repository/DB)を分離するMVVM構成を採用します。  
現状のファイルをどこに配置すべきか、今後どこへ追加していけばよいかをまとめます。

---

### 推奨ディレクトリ構成（概要）

```
lib/
  app/
    app.dart                // MaterialApp.routerやアプリ共通初期化
    routes.dart             // GoRouterルート定義（分離推奨）
    di/                     // 依存性注入（必要になったら）
  core/
    theme/
      colors.dart           // テーマ/カラーパレット等の共通リソース
    utils/                  // 共通ユーティリティ（拡張/フォーマッタ等）
    constants/              // 定数
  data/
    models/                 // データモデル（シンプルなDTO等）
    repositories/           // リポジトリ（DB/APIを抽象化）
    local/
      drift/
        database.dart       // Driftテーブル/DAO/DB接続
        database.g.dart     // Driftの自動生成ファイル（編集しない）
    remote/                 // 将来APIクライアント等を追加する場合
  domain/                   // 任意（規模拡大時に使用）
    entities/               // ドメインエンティティ
    usecases/               // ユースケース（アプリケーションサービス）
  ui/
    pages/
      home/
        home_page.dart
      settings/
        settings_page.dart
      color_palette/
        color_palette_page.dart
    widgets/
      common/               // 共有ウィジェット
  view_model/
    home/
      home_view_model.dart  // 画面ごとの状態・ロジック
  main.dart                 // エントリポイント（そのままでもOK）
```

ポイント:
- 画面は`ui/pages/<feature>/<feature>_page.dart`
- 状態は`view_model/<feature>/<feature>_view_model.dart`
- データ永続化は`data/local/drift/`、その上に`data/repositories/`で抽象化
- テーマや定数など横断的なものは`core/`へ
- ルーティングは`app/routes.dart`で管理し、`app/app.dart`から参照

---

### 既存ファイルの分類（移動先の提案）

- `lib/main.dart`
  - 種別: エントリポイント
  - 配置: そのまま`lib/main.dart`で可
  - 補足: `MaterialApp.router`や初期化処理を`app/app.dart`へ切り出すと保守性が上がります

- `lib/home.dart`
  - 種別: 画面(UI) + DBロジックが混在
  - 配置: `lib/ui/pages/home/home_page.dart`
  - 補足: DBアクセス（`watchActivityPoints()`, `insertActivityPoint()`等）は`view_model/home/home_view_model.dart`へ移し、Viewは`ViewModel`を監視するだけにするのがMVVMの基本です

- `lib/settings_page.dart`
  - 種別: 画面(UI)
  - 配置: `lib/ui/pages/settings/settings_page.dart`

- `lib/color_palette_page.dart`
  - 種別: 画面(UI)
  - 配置: `lib/ui/pages/color_palette/color_palette_page.dart`

- `lib/colors.dart`
  - 種別: テーマ/カラー
  - 配置: `lib/core/theme/colors.dart`
  - 補足: 既存の`AppThemeExtension`はこのまま`core/theme`に置くのが自然です

- `lib/database.dart` / `lib/database.g.dart`
  - 種別: Drift（DB）
  - 配置: `lib/data/local/drift/database.dart` と 自動生成の`database.g.dart`
  - 補足: `database.g.dart`は`build_runner`で再生成されるため、手動編集しないこと

- `lib/text/*.md`
  - 種別: ドキュメント
  - 配置: 現状のままでOK（アプリコード外）

---

### 今後追加するファイルの置き場所（ガイド）

- 新しい画面を追加する
  - 例: `Profile`画面 → `lib/ui/pages/profile/profile_page.dart`
  - ページ固有の小さなコンポーネントは同階層に`components/`や`widgets/`を切って配置可
  - 複数ページで使い回す汎用ウィジェットは`lib/ui/widgets/common/`

- 画面の状態・ロジック（ViewModel）
  - 例: `ProfileViewModel` → `lib/view_model/profile/profile_view_model.dart`
  - 役割: 入力値の検証、DB/Repository呼び出し、`Stream/ChangeNotifier/ValueNotifier`等でUIへ状態通知
  - ライブラリ: 追加依存なしで`ChangeNotifier`等から開始し、必要に応じてRiverpod/Blocへ拡張

- リポジトリ（データ取得の抽象化）
  - 例: `ActivityPointsRepository` → `lib/data/repositories/activity_points_repository.dart`
  - 役割: DBやAPIの詳細を隠蔽し、ViewModelへユースケース指向のメソッドを提供
  - DBアクセス（Drift）は`data/local/drift/`からここ経由で利用

- モデル（DTO/エンティティ）
  - シンプルなデータ転送用: `lib/data/models/`
  - ドメイン厳格化したい場合: `lib/domain/entities/`（規模拡大時に導入）

- ユースケース（任意）
  - 例: `AddActivityPoint` → `lib/domain/usecases/add_activity_point.dart`
  - アプリケーションサービスとして、複合的な操作に意味付けする層（必要性が出てからでOK）

- ルーティング
  - 追加・変更は`lib/app/routes.dart`
  - `GoRouter`の`routes`/`ShellRoute`等はここで定義し、`app/app.dart`から読み込む

- DI（依存性注入、任意）
  - シンプルな段階では、`main.dart`で`AppDatabase`を生成し、Repository→ViewModelへコンストラクタ注入で十分
  - 本格導入時は`lib/app/di/`にプロバイダやロケータを配置

---

### 命名規約（簡易）

- ファイル名: スネークケース（例: `home_view_model.dart`, `activity_points_repository.dart`）
- ViewModel: `<feature>_view_model.dart`（例: `home_view_model.dart`）
- Repository: `<resource>_repository.dart`（例: `activity_points_repository.dart`）
- ページ: `<feature>_page.dart`（例: `home_page.dart`）
- 共有ウィジェット: `<purpose>_widget.dart`（例: `app_logo_widget.dart`）

---

### 最小移行ステップ（参考）

1) ファイル移動  
   - 上記の配置へ物理移動（`database.g.dart`は生成物のため場所が変わるとビルドで再生成されます）

2) import更新  
   - 例: `import 'package:practice/colors.dart';` → `import 'package:practice/core/theme/colors.dart';`

3) ルーター分離（任意だが推奨）  
   - `lib/app/routes.dart`を作成し、既存の`_router`定義を移す  
   - `MaterialApp.router(routerConfig: AppRoutes.router)`のように参照

4) HomeのMVVM化  
   - DBアクセスは`view_model/home/home_view_model.dart`へ移動  
   - View（`home_page.dart`）はViewModelの公開する`Stream/Notifier`を購読して表示のみ担当  
   - Repository（`data/repositories/`）を挟んで`AppDatabase`を利用

---

### 実装上の注意

- Driftの`database.g.dart`は自動生成。手動編集しないこと
- `AppDatabase`のインスタンスはアプリ全体で1つを基本とし、Repository→ViewModelへコンストラクタ注入  
- UIは「入力取得と描画」に専念し、副作用や保存処理はViewModel/Repositoryへ委譲

---

この構成に沿っておけば、画面追加や機能拡張時の見通しが良くなり、テストもしやすくなります。必要に応じて`domain/`層を後付けで導入できるよう、UIとデータアクセスのあいだにRepositoryを置くのがポイントです。


