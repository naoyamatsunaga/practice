## ダイアログでの数値バリデーション（ポイント入力）

ダイアログに「ポイント」を入力させる際、数値以外が入った場合は登録させない実装手順です。  
以下の方針で実装すると、入力時と登録時の両方で堅牢にチェックできます。

- **即時制御（推奨）**: `FilteringTextInputFormatter.digitsOnly` で非数値をそもそも入力不可にする
- **最終検証（必須）**: `Form` + `TextFormField.validator` で「空/非数値/範囲外」をチェックし、NGならダイアログを閉じない

---

### 使い方（手順）
1. ダイアログ内の入力を `Form` と `TextFormField` で構成する  
2. `TextFormField` に `validator` を設定して、空/非数値/負数などを弾く  
3. 可能なら `FilteringTextInputFormatter.digitsOnly` を併用して、非数値を物理的に入力不可にする  
4. 「登録」ボタンで `formKey.currentState!.validate()` を呼び、OKのときだけ `Navigator.pop(context, 入力値)` で値を返す  
5. 呼び出し側は `null`（キャンセル or 無効）なら登録処理をしない

---

### サンプルコード（そのまま貼って使えます）

```dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

/// ポイント入力ダイアログを表示し、正常なら int（ポイント）を返します。
/// キャンセルまたは無効入力のときは null を返します。
Future<int?> showPointInputDialog(BuildContext context) async {
  final formKey = GlobalKey<FormState>();
  final controller = TextEditingController();

  final result = await showDialog<int>(
    context: context,
    barrierDismissible: false, // 外タップで閉じない（誤操作防止）
    builder: (context) {
      return AlertDialog(
        title: const Text('ポイントを入力'),
        content: Form(
          key: formKey,
          child: TextFormField(
            controller: controller,
            decoration: const InputDecoration(
              labelText: 'ポイント',
              hintText: '例: 120',
            ),
            autofocus: true,
            keyboardType: TextInputType.number,
            inputFormatters: const [
              FilteringTextInputFormatter.digitsOnly, // 数字のみ許可
            ],
            validator: (value) {
              final text = (value ?? '').trim();
              if (text.isEmpty) {
                return '必須です';
              }
              final n = int.tryParse(text);
              if (n == null) {
                return '数字のみで入力してください';
              }
              if (n < 0) {
                return '0以上で入力してください';
              }
              return null;
            },
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(null),
            child: const Text('キャンセル'),
          ),
          FilledButton(
            child: const Text('登録'),
            onPressed: () {
              final ok = formKey.currentState!.validate();
              if (!ok) return; // 無効なら閉じない
              final n = int.parse(controller.text.trim());
              Navigator.of(context).pop(n); // 正常値を呼び出し側へ返す
            },
          ),
        ],
      );
    },
  );

  controller.dispose();
  return result;
}
```

---

### 呼び出し例（登録処理側）

```dart
// 例: ボタン押下時
onPressed: () async {
  final points = await showPointInputDialog(context);
  if (points == null) {
    // キャンセル or 無効入力 → 何もしない
    return;
  }
  // ここでのみ登録処理を実行
  await registerPoints(points);
},
```

---

### メモ
- **小数を許可したい**: `TextInputType.numberWithOptions(decimal: true)` と  
  `FilteringTextInputFormatter.allow(RegExp(r'[0-9]+([.][0-9]+)?'))` に変更、`double.tryParse` で検証してください。
- **最大・最小値の制限**: `validator` で `n > max` や `n < min` を追加してください。
- **即時エラー表示**: `autovalidateMode: AutovalidateMode.onUserInteraction` を `TextFormField` に付けると入力中にエラーを表示できます。


